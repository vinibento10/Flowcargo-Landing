name: Verify Secrets

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executar diariamente Ã s 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:
    # Permitir execuÃ§Ã£o manual

jobs:
  verify_secrets:
    runs-on: ubuntu-latest
    name: Check Required Secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Verify GitHub Secrets
        id: verify
        run: |
          python3 scripts/verify_github_secrets.py \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --owner ${{ github.repository_owner }} \
            --repo ${{ github.event.repository.name }}
        continue-on-error: true
      
      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-verification-report
          path: reports/
          retention-days: 30
      
      - name: Check verification result
        id: check_result
        run: |
          # Verificar se o arquivo de relatÃ³rio foi criado
          if [ -f "reports/secrets_verification_"*.json ]; then
            echo "Report generated successfully"
            
            # Extrair status do relatÃ³rio
            COMPLETE=$(python3 -c "
            import json
            import glob
            
            report_file = glob.glob('reports/secrets_verification_*.json')[0]
            with open(report_file, 'r') as f:
              data = json.load(f)
              print(data['summary']['required']['complete'])
            ")
            
            echo "complete=$COMPLETE" >> $GITHUB_OUTPUT
          else
            echo "complete=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with verification result
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const glob = require('glob');
            
            // Ler relatÃ³rio
            const reportFiles = glob.sync('reports/secrets_verification_*.json');
            if (reportFiles.length === 0) {
              console.log('No report found');
              return;
            }
            
            const report = JSON.parse(fs.readFileSync(reportFiles[0], 'utf8'));
            const summary = report.summary;
            
            let comment = '## ðŸ” GitHub Secrets Verification\n\n';
            
            if (summary.required.complete) {
              comment += 'âœ… **Status: COMPLETO**\n\n';
            } else {
              comment += 'âŒ **Status: INCOMPLETO**\n\n';
            }
            
            comment += `### Required Secrets: ${summary.required.found}/${summary.required.total}\n`;
            
            if (summary.required.complete) {
              comment += 'âœ… Todos os secrets obrigatÃ³rios foram configurados!\n\n';
            } else {
              comment += 'âŒ Faltam secrets obrigatÃ³rios\n\n';
              comment += 'Secrets faltando:\n';
              
              Object.entries(report.details.required).forEach(([key, status]) => {
                if (status.includes('NÃ£o encontrado')) {
                  comment += `- âŒ ${key}\n`;
                }
              });
              
              comment += '\n[Configure os secrets aqui](https://github.com/${{ github.repository }}/settings/secrets/actions)\n\n';
            }
            
            comment += `### Optional Secrets: ${summary.optional.found}/${summary.optional.total}\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Fail if secrets incomplete
        if: steps.check_result.outputs.complete == 'false' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "âŒ Secrets obrigatÃ³rios nÃ£o estÃ£o configurados"
          echo "Configure os secrets em: https://github.com/${{ github.repository }}/settings/secrets/actions"
          exit 1
      
      - name: Send Slack notification on failure
        if: failure() && github.event_name == 'push'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âš ï¸ GitHub Secrets Verification Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*GitHub Secrets Verification Failed*\n\nAlguns secrets obrigatÃ³rios estÃ£o faltando ou invÃ¡lidos."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Configure Secrets"
                      },
                      "url": "https://github.com/${{ github.repository }}/settings/secrets/actions"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        if: always()

  pre_deploy_check:
    runs-on: ubuntu-latest
    name: Pre-Deploy Secrets Check
    needs: verify_secrets
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download verification report
        uses: actions/download-artifact@v4
        with:
          name: secrets-verification-report
      
      - name: Verify all required secrets before deploy
        run: |
          echo "ðŸ” Verificando se todos os secrets estÃ£o configurados antes do deploy..."
          
          if [ -f "secrets_verification_"*.json ]; then
            COMPLETE=$(python3 -c "
            import json
            import glob
            
            report_file = glob.glob('secrets_verification_*.json')[0]
            with open(report_file, 'r') as f:
              data = json.load(f)
              complete = data['summary']['required']['complete']
              print('true' if complete else 'false')
            ")
            
            if [ "$COMPLETE" = "true" ]; then
              echo "âœ… Todos os secrets estÃ£o configurados"
              echo "âœ… Deploy pode prosseguir"
              exit 0
            else
              echo "âŒ Secrets obrigatÃ³rios faltando"
              echo "âŒ Deploy serÃ¡ bloqueado"
              exit 1
            fi
          else
            echo "âš ï¸  RelatÃ³rio nÃ£o encontrado"
            exit 1
          fi
      
      - name: Notify deploy readiness
        if: success()
        run: |
          echo "âœ… Sistema pronto para deploy"
          echo "âœ… Todos os secrets verificados"
          echo "âœ… CI/CD pode prosseguir"

  summary:
    runs-on: ubuntu-latest
    name: Verification Summary
    needs: verify_secrets
    if: always()
    
    steps:
      - name: Download verification report
        uses: actions/download-artifact@v4
        with:
          name: secrets-verification-report
      
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Secrets Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "secrets_verification_"*.json ]; then
            python3 << 'EOF'
            import json
            import glob
            
            report_file = glob.glob('secrets_verification_*.json')[0]
            with open(report_file, 'r') as f:
              data = json.load(f)
            
            summary = data['summary']
            details = data['details']
            
            # Adicionar ao GITHUB_STEP_SUMMARY
            with open('/tmp/summary.md', 'w') as f:
              f.write("### Required Secrets\n\n")
              f.write(f"**Status:** {summary['required']['found']}/{summary['required']['total']}\n\n")
              
              for secret, status in details['required'].items():
                emoji = "âœ…" if "Encontrado" in status else "âŒ"
                f.write(f"{emoji} {secret}\n")
              
              f.write("\n### Optional Secrets\n\n")
              f.write(f"**Status:** {summary['optional']['found']}/{summary['optional']['total']}\n\n")
              
              for secret, status in details['optional'].items():
                emoji = "âœ…" if "Encontrado" in status else "âšª"
                f.write(f"{emoji} {secret}\n")
            
            with open('/tmp/summary.md', 'r') as f:
              print(f.read())
            EOF
          fi
